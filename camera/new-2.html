<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Webcam 320x240 dengan Koordinat</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        
        /* Ukuran Container sesuai permintaan (320x240) */
        #my_camera { 
            width: 320px; 
            height: 240px; 
            border: 1px solid #ccc; 
            margin: 0 auto; 
            background-color: #eee;
        }
        
        #results { margin-top: 20px; }

        /* Styling tombol */
        button {
            margin-top: 15px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <h3>Ambil Foto (320x240)</h3>
    
    <div id="my_camera"></div>
    
    <button id="btn-capture" onClick="take_snapshot()" disabled>Sedang mencari lokasi...</button>
    
    <div id="results"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>

    <script>
        // 1. Konfigurasi Webcam (320x240 Standar)
        Webcam.set({
            width: 320,
            height: 240,
            
            // Output juga disamakan 320x240 (Tanpa Crop)
            dest_width: 320,
            dest_height: 240,
            
            image_format: 'jpeg',
            jpeg_quality: 90
        });
        Webcam.attach('#my_camera');

        // Variabel Global
        var currentLat = null;
        var currentLng = null;
        var btnCapture = document.getElementById('btn-capture');

        // 2. Geolocation (Agar tombol aktif hanya setelah lokasi dapat)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    
                    // Aktifkan Tombol
                    btnCapture.disabled = false;
                    btnCapture.innerText = "Ambil Gambar";
                    console.log("Lokasi siap.");
                }, 
                function(error) {
                    // Error Handling
                    alert("Gagal ambil lokasi. Foto akan tanpa koordinat.");
                    currentLat = "-";
                    currentLng = "-";
                    btnCapture.disabled = false;
                    btnCapture.innerText = "Ambil Gambar (Tanpa Lokasi)";
                },
                { enableHighAccuracy: true }
            );
        } else {
            alert("Browser tidak mendukung Geolocation.");
        }

        // 3. Ambil Gambar
        function take_snapshot() {
            Webcam.snap(function(data_uri) {
                addTextToImage(data_uri, function(finalImage) {
                    document.getElementById('results').innerHTML = 
                        '<h4>Hasil (320x240):</h4>' + 
                        '<img src="'+finalImage+'"/>';
                });
            });
        }

        // 4. Proses Canvas (Watermark)
        function addTextToImage(imageSrc, callback) {
            var img = new Image();
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');

                // Set Canvas ke 320x240
                canvas.width = 320;
                canvas.height = 240;

                ctx.drawImage(img, 0, 0);

                // --- Styling Teks ---
                ctx.font = "bold 11px Arial";
				ctx.fillStyle = "white";
				ctx.textAlign = "left";
				ctx.strokeStyle = 'black';
				ctx.lineWidth = 2;

				var dateStr = new Date().toLocaleString();
				var latStr = "Lat: " + (currentLat !== null ? Number(currentLat).toFixed(7) : "-");
				var lngStr = "Long: " + (currentLng !== null ? Number(currentLng).toFixed(7) : "-");

                // Posisi Teks (Mulai dari bawah)
                var x = 10;
                // Karena tinggi cuma 240, kita mulai nulis dari y=190-an
                var startY = 190; 

                // Tulis Tanggal
                ctx.strokeText(dateStr, x, startY);
                ctx.fillText(dateStr, x, startY);

                // Tulis Latitude
                ctx.strokeText(latStr, x, startY + 15);
                ctx.fillText(latStr, x, startY + 15);

                // Tulis Longitude
                ctx.strokeText(lngStr, x, startY + 30);
                ctx.fillText(lngStr, x, startY + 30);

                var finalDataUrl = canvas.toDataURL('image/jpeg');
                callback(finalDataUrl);
            };
            img.src = imageSrc;
        }
    </script>
</body>
</html>